<!doctype html>
<html>

<head>
<style>
</style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.9.0/underscore-min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.3.3/backbone-min.js"></script>
  
  <script crossorigin src="https://unpkg.com/react@16/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/react/0.13.3/JSXTransformer.js'></script>

    <!--      
Pay dates - Cutoff Dates for 2018-2019
CUTOFF DATE              PAY DATE
Saturday 19 May          - Friday 25 May  
Saturday 16 June         - Tuesday 26 June             4 sundays
Saturday 14 July         - Thursday 26 July            4 sundays
Saturday 18 August       - Friday 24 August             5 sundays
Saturday 15 September    - Wednesday 26 September          4 sundays
Saturday 20 October      - Friday 26 October          5 sundays
Saturday 17 November     - Monday 26 November           4 sundays
Saturday 15 December     - Friday 21 December     4 sundays
Saturday 19 January      - Friday 25 January   


Net Hours worked on Sunday after break = 6.5
Net pay on Sunday before time and a half = 59.345 
Time and a half on a Sunday - 29.6725 
Total Pay on Sunday = 89.0175

Bank Holiday monday = 8 hours 
Net pay on Bank holiday monday before time and a half = 73.04
Time and half on bank holiday 8 hours = 36.52
Total pay on Bank Holiday Monday = 109.56 -->

<script>

  function getRealPayDate(date) {
      if (date.getDay() == 1) {
          var dayOfMonth = date.getDate();
          date.setDate(dayOfMonth - 2);
      }

      var dayOfMonth = date.getDate();
      date.setDate(dayOfMonth - 1);
      return date;
  }

  const cutoff_dates = { 2018: [new Date(2018, 2, 17), new Date(2018, 3, 14),new Date(2018, 4, 19), new Date(2018, 5, 16), new Date(2018, 6, 14), new Date(2018, 7, 18), new Date(2018, 8, 15), new Date(2018, 9, 20), new Date(2018, 10, 17), new Date(2018, 11, 15)] }
  
  const pay_dates = { 2018:{2:26 ,3: 26, 4: 25, 5: 26, 6: 26, 7: 24, 8: 26, 9: 26, 10: 26, 11: 21 }}

  var BANK_HOLIDAYS = [new Date(2018, 4, 7), new Date(2018, 4, 28), new Date(2018, 7, 27), new Date(2018, 11, 25), new Date(2018, 11, 26), new Date(2019, 0, 1)]

  var OvertimeHours = Backbone.Model.extend({
      isSunday: function() {
          if (this.get("start").getDay() === 0) {
              return true
          }
          return false;
      },
      isBankHoliday: function() {
        var shift_date=this.get("start")
        var is_bank_holiday = false;
          _.each(BANK_HOLIDAYS, function(bank_holiday_date, i) {
            
              if ((bank_holiday_date.getDate() == shift_date.getDate()) && (bank_holiday_date.getMonth() == shift_date.getMonth()) && (bank_holiday_date.getYear() == shift_date.getYear())) {
            
                  is_bank_holiday = true
              }
          }, this);
          return is_bank_holiday
      },
      lengthOfShift: function() {
        return Math.abs(this.get("finish") - this.get("start")) / (60 * 60 * 1000);
      },
      lengthOfShiftAfterBreaksDeducted: function() {
        return this.lengthOfShift() - this.calculateBreaks()
      },
      premium: function() {
        
        if (this.isBankHoliday() || this.isSunday()) {
          
          return this.lengthOfShiftAfterBreaksDeducted() * 0.5;
        }else {
          return 0;
        }
      },
      calculateBreaks: function() {
        var length_of_shift = this.lengthOfShift()
        if(length_of_shift < 6 && length_of_shift >= 4.5) {
          var breaks = 0.25;
        } else if (length_of_shift < 8 && length_of_shift >= 6) {
          var breaks = 0.5
        } else if (length_of_shift < 10 && length_of_shift >= 8 ) {
          var breaks = 0.75
        } else if (length_of_shift >= 10) {
          var breaks = 1
        } else { 
          breaks = 0
        }
        return breaks
      },
      totalHoursIncludingPremium: function() {
      return  this.lengthOfShiftAfterBreaksDeducted()  + this.premium()
      }
  })

  var Overtime = Backbone.Collection.extend({
    model:OvertimeHours,
    getOvertimeForMonth: function(previous_cutoff_date, cutoff_date) {
      
   return  this.select(function(overtime) {
      return (overtime.get("start").getTime() <= cutoff_date.getTime()) && (overtime.get("start").getTime() >= previous_cutoff_date.getTime())
      })
    }
  })
  var overtime_hours = new Overtime([{
    start: new Date(2018, 3, 17, 15, 30),
    finish: new Date(2018, 3, 17, 20, 15)
  }, {
    start: new Date(2018, 3, 24, 15, 30),
    finish: new Date(2018, 3, 24, 20, 15)
  }, {
    start: new Date(2018, 5, 7, 15, 30),
    finish: new Date(2018, 5, 7, 20, 15)
  }, {
    start: new Date(2018, 5, 8, 15, 30),
    finish: new Date(2018, 5, 8, 20, 15)
  },
  {
    start: new Date(2018, 5, 6, 15, 30),
    finish: new Date(2018, 5, 6, 20, 15)
  },
{  start: new Date(2018, 5, 12, 13, 30),
  finish: new Date(2018, 5, 12, 20, 15)},
  {
    start: new Date(2018, 5, 19, 12, 30),
    finish: new Date(2018, 5, 19, 20, 15)
  }, {
    start: new Date(2018, 6, 3, 15, 30),
    finish: new Date(2018, 6, 3, 20, 15)
  }, {
    start: new Date(2018, 6, 10, 12, 30),
    finish: new Date(2018, 6, 10, 20, 15)
  }, {
    start: new Date(2018, 6, 17, 14, 00),
    finish: new Date(2018, 6, 17, 20, 15)
  },
   {
    start: new Date(2018, 6, 24, 12, 30),
    finish: new Date(2018, 6, 24, 20, 15)
  }])
  
  
  
  var BackBonePayMonth = Backbone.Model.extend({
    defaults: {
      hourly_rate: 9.13,
      contract_hours_at_premium:6.5,
      contract_hours_at_standard_rate:16,
      contract_days: [ 6.5, 8, 0, 0, 0, 8, 8 ], // Array indices 0 to 7 represent day of week, value represents hours worked after unpaid breaks deducted
      year:2018,
      month:6,
      pension_employee: 30.66 // Calculated by adding up (12 * monthly contractual pay + 52 * weekly sunday premiums and then dividing the total by 12. Then 3/100 of that result)
    },
    cutOffDate: function() {
      var that = this;
      return _.find(cutoff_dates[this.get("year")], function(date) {
        return date.getMonth() == that.get("month")
      })
    },
    payDate: function() {
      return pay_dates[this.get("year")][this.get("month")]
    },
    previousCutOffDate: function() { // Update to handle previous year
        var that = this;
      return _.find(cutoff_dates[this.get("year")], function(date) {
        return date.getMonth() == that.get("month") -1
      })
    },
    overTimeTravelCost:function() {
      
    },
    numberOfSundays: function() {
      var fromDate = new Date(this.previousCutOffDate());
      var toDate = new Date(this.cutOffDate());
      var sundayCount = 0;

      while (fromDate < toDate) {
          fromDate.setDate(fromDate.getDate() + 1);
          
          if (fromDate.getDay() === 0) {
              
              ++sundayCount;
          }
      }
      return sundayCount;
    },
    monthlyContractualPay: function() {

      return (((this.get("contract_hours_at_premium") + this.get("contract_hours_at_standard_rate")) * this.get("hourly_rate")) * 52.17857142) / 12;
    },
    bankHolidaysWorked: function(){
      var bank_holidays_applicable = [];
        _.each(BANK_HOLIDAYS, function(bank_holiday_date) {
            if(this.get("contract_days")[bank_holiday_date.getDay()] > 0) {
              bank_holidays_applicable.push(bank_holiday_date)
            }
        },this)
     return  _.select(bank_holidays_applicable,function(bh) {
        return (bh.getTime() <= this.cutOffDate().getTime()) && (bh.getTime() >= this.previousCutOffDate().getTime())
    }, this)
    
    },
    overtimeForMonth: function() {
      var overtime = overtime_hours.getOvertimeForMonth(this.previousCutOffDate(), this.cutOffDate())
    
      var total = 0;
      overtime.forEach(function(o) {
       total=total + o.totalHoursIncludingPremium()
      })
      return total * this.get("hourly_rate")
    },
    calculatePayForMonth: function() {
      var bank_holidays_worked = this.bankHolidaysWorked();
      var bank_holiday_premiums = 0;
      bank_holidays_worked.forEach(function(bh) {
        
        bank_holiday_premiums = bank_holiday_premiums +   this.get("contract_days")[bh.getDay()]
      }, this)
      bank_holiday_premiums = (bank_holiday_premiums / 2) * this.get("hourly_rate")
      const monthly_tax_free_allowance = 988.25;
      var national_insurance_monthly_allowance = (162*52)/12; //8424
      this.set("gross_pay", this.sundayPremiums() + this.monthlyContractualPay() + bank_holiday_premiums + this.overtimeForMonth());
      this.set("gross_pay_after_pension_contributions", this.get("gross_pay") - this.get("pension_employee"))
      this.set("bank_holiday_premiums", bank_holiday_premiums)
      this.set("national_insurance_deducted",(12/100 * (this.get("gross_pay") - national_insurance_monthly_allowance)));
      this.set("tax", (20/100* (this.get("gross_pay_after_pension_contributions") - monthly_tax_free_allowance)));
      return this.get("gross_pay_after_pension_contributions")-this.get("tax") - this.get("national_insurance_deducted");
    },
    sundayPremiums: function() {
      return(this.numberOfSundays() * this.get("contract_hours_at_premium") * (0.5*this.get("hourly_rate")))
    }
  })
  
  
  var backbone_pay_month = new BackBonePayMonth()
        
</script>
</head>

<body>
    <div id="root"></div>
</body>


<!-- REACT -->

<script type="text/jsx">
const monthNames = ["January", "February", "March", "April", "May", "June",
  "July", "August", "September", "October", "November", "December"
];

class PayDate extends React.Component {
  constructor(props) {
    super(props);
  }
  
  render() {
    return <option value={this.props.month}>{monthNames[this.props.month]}</option>
  }   
}


class PayForMonth extends React.Component {
  
  render() {
    return (<div><h1>Date: {monthNames[this.props.month]}</h1>
    Contractual pay for month: {backbone_pay_month.calculatePayForMonth()}<br/>
    Number of Sundays: {backbone_pay_month.numberOfSundays()}<br/>
    Overtime Hours: {backbone_pay_month.overtimeForMonth()}<br/>
    Sunday premiums: {backbone_pay_month.sundayPremiums()}<br/>
    BH premiums: {backbone_pay_month.get("bank_holiday_premiums")}<br/>
    
    Gross pay after pension contributions: {backbone_pay_month.get("gross_pay_after_pension_contributions")}<br/>
    Gross pay: {backbone_pay_month.get("gross_pay")}<br/>
    Tax: {backbone_pay_month.get("tax")}<br/>
    National Insurance: {backbone_pay_month.get("national_insurance_deducted")}</div>
    )
  }
}


class PayDates extends React.Component {
  constructor(props) {
    super(props);
    this.state = {value: ""};
    this.change = this.change.bind(this);
  }
  
  change(event){
     backbone_pay_month.set("month",event.target.value)
     backbone_pay_month.calculatePayForMonth();
     this.setState({value: event.target.value});
  }
     
  render() {

    var elements = [];
    
    Object.keys(pay_dates[2018]).forEach(function(key) {
      var month = key
        elements.push(<PayDate key={monthNames[month]} month={month}/>)
    });
    
    return (
      <div>
        <select id="pay_date"  onChange={this.change} value={this.state.value}>
          {elements}
        </select>
        <PayForMonth month={this.state.value} ></PayForMonth>
      </div>)
  }
}

ReactDOM.render(
  <PayDates />,
  document.getElementById('root')
);
    </script>
</html>