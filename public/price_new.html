<!doctype html>
<html>

<head>

  <script type="text/template" id="size_option">
    <select class="size_option">
    <option value="1">1</option>
    <option value="0.25">Quarter</option>
    <option value="0.5">Half</option>
    
    <option value="0.1666666666">Sixth</option>
    <option value="0.125">Eighth</option>
    <option value="2">2</option>
    <option value="3">3</option>
    <option value="4">4</option>
    <option value="5">5</option>
    </select>
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.3.3/backbone-min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/backbone-localstorage.js/1.1.16/backbone.localStorage-min.js"></script>
  <script src="items_for_price_calculator.js"></script>
  <script>
    $(function() {


// MODELS
//////////////////////////////////////////////////////////////////////

      var Item = Backbone.Model.extend({
        initialize: function() {
          this.on("change", this.calculate)
        },
        calculate: function() {
          if (this.get("type")) {
            var information = items[this.get("type")]
            var cost = (information.price / information.quantity) * this.get("size")
            this.set("cost", cost)
          }
        },
        defaults: {
          "size": 1
        }
      })
      
      var Quote = Backbone.Model.extend({
        initialize: function() {
          this.set("items_for_calculation", new ItemsForCalculation({}))
        }
      })
      
// COLLECTIONS
////////////////////////////////////////////////////////////////////////////

      var ItemsForCalculation = Backbone.Collection.extend({
        model:Item
      })

      var Quotes = Backbone.Collection.extend({  
        model: Quote,
        localStorage: new Backbone.LocalStorage("casamiento-quotes")
      })
      
// VIEWS 
///////////////////////////////////////////////////////////////////////////////

      var ItemsForCalculationView = Backbone.View.extend({
        initialize: function() {
          this.listenTo(this.model, "change:cost", this.renderCost)
        },
        events: {
          'change .size_option': 'changeSize',
          "change .type": "changeType",
          "click .delete": "remove"
        },
        removeView: function() {
          this.model.destroy();
          this.remove();
        },
        changeSize: function(e) {
          var size = $(e.currentTarget).val()
          this.model.set("size", size)
        },
        changeType: function(e) {
          var type = $(e.currentTarget).val()
          this.model.set("type", type)
        },
        renderCost: function() {
          this.$('.cost').html(this.model.get("cost"))
        },
        render: function() {
          this.$el.html("<select class='type'></select>")
          for (var key in items) {
            console.log(this.model.get("type"))
            this.$('select').append("<option value='" + key + "'>" + key + "</option>")
          }
          var template = _.template($('#size_option').html())

          this.$el.append(template())
          this.$el.append("<div class='cost'></div>")

          this.$el.append("<div class='delete'>DELETE XXXX</div>")
          this.$el.append("<div class='name' contenteditable='true'>name</div>")
          return this;
        }
      })
      
      var QuoteView = Backbone.View.extend({
        
        initialize: function() {
          this.listenTo(this.model.get("items_for_calculation"), 'add', this.render)
          },
          events: {
          'click .add_item': 'addItem'
        },
        addItem: function() {
          var item = this.model.get("items_for_calculation");
          item.add({})
        },
        render: function() {
          var items = this.model.get("items_for_calculation")
          this.$el.html("<hr/>")
          items.forEach(function(item) {
             var view = new ItemsForCalculationView({model:item}).render().el
             this.$el.append(view)
          }, this)
          this.$el.append("<div class='add_item'>Add item</div>")
          return this;
        }
      })
      
      var AppView = Backbone.View.extend({
        el: $('#app'),
        initialize: function() {
          this.render();
          this.quotes = new Quotes();
        },
        events: {
          'click #new_quote': 'createNewQuote'
        },
        createNewQuote: function() {
          var new_quote = this.quotes.add({name: window.prompt("Type a name for this quote")})
          var qv = new QuoteView({model: new_quote}).render().el
         this.$el.append(qv)
        },
        render: function() {
          this.$el.html("<div id='new_quote'>New Quote</div><hr/>")
        }
      })
      new AppView().render();
    })
  </script>

</head>

<div id="app"></div>

</html>